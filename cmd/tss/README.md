# TSS Demo

## Quick Start

Start 3 nodes in separate terminals using the test script:

```bash
# Terminal 1
./scripts/test_tss.sh pushvaloper1fv2fm76q7cjnr58wdwyntzrjgtc7qya6n7dmlu 39001 30B0D912700C3DF94F4743F440D1613F7EA67E1CEF32C73B925DB6CD7F1A1544

# Terminal 2
./scripts/test_tss.sh pushvaloper12jzrpp4pkucxxvj6hw4dfxsnhcpy6ddty2fl75 39002 59BA39BF8BCFE835B6ABD7FE5208D8B8AEFF7B467F9FE76F1F43ED392E5B9432

# Terminal 3
./scripts/test_tss.sh pushvaloper1vzuw2x3k2ccme70zcgswv8d88kyc07grdpvw3e 39003 957590C7179F8645368162418A3DF817E5663BBC7C24D0EFE1D64EFFB11DC595
```

The script automatically:

- Builds the binary
- Cleans up previous runs (database and home directory)
- Starts the node with proper configuration
- Logs to `./tss-data/tss-<validator>.log`

Wait a few seconds for nodes to register, then trigger operations:

```bash
# Generate a new keyshare (keyID is auto-generated by DKLS)
./build/tss keygen

# Refresh the current keyshare
./build/tss keyrefresh

# Trigger a quorum change (add/remove participants)
./build/tss qc

# Sign a message
./build/tss sign -message="Hello, World!"

# Prepare environment (clean TSS files and build latest binary)
./build/tss prepare
```

## Complete Testing Flow

This flow demonstrates the full lifecycle of the TSS system:

```bash
# Step 1: Prepare environment (clean and build)
./build/tss prepare

# Step 2: Start Node 1 (Pending Join)
./build/tss node -validator-address=pushvaloper1fv2fm76q7cjnr58wdwyntzrjgtc7qya6n7dmlu -private-key=30B0D912700C3DF94F4743F440D1613F7EA67E1CEF32C73B925DB6CD7F1A1544 -p2p-listen=/ip4/127.0.0.1/tcp/39001

# Step 3: Start Node 2 (Pending Join) - in a new terminal
./build/tss node -validator-address=pushvaloper12jzrpp4pkucxxvj6hw4dfxsnhcpy6ddty2fl75 -private-key=59BA39BF8BCFE835B6ABD7FE5208D8B8AEFF7B467F9FE76F1F43ED392E5B9432 -p2p-listen=/ip4/127.0.0.1/tcp/39002

# Step 4: Do keygen - Marks Node 1 & 2 as Active
./build/tss keygen

# Step 5: Do sign
./build/tss sign -message="Test message 1"

# Step 6: Start Node 3 (Pending Join) - in a new terminal
./build/tss node -validator-address=pushvaloper1vzuw2x3k2ccme70zcgswv8d88kyc07grdpvw3e -private-key=957590C7179F8645368162418A3DF817E5663BBC7C24D0EFE1D64EFFB11DC595 -p2p-listen=/ip4/127.0.0.1/tcp/39003

# Step 7: Do sign (with 2 active nodes)
./build/tss sign -message="Test message 2"

# Step 8: Do QC - Marks Node 3 as Active
./build/tss qc

# Step 9: Do sign (with 3 active nodes)
./build/tss sign -message="Test message 3"

# Step 10: Stop Node 2 (Mark as Pending Leave)
# (Stop the Node 2 process - Ctrl+C in its terminal)

# Step 11: Do QC - Marks Node 2 as Inactive
./build/tss qc

# Step 12: Do sign (with 2 active nodes: Node 1 & 3)
./build/tss sign -message="Test message 4"
```

**Note:** In a real implementation, the validator status changes (Pending Join → Active, Active → Pending Leave → Inactive) would be managed by the data provider based on blockchain state. For testing purposes, you can use the `status` command to manually set node statuses.

### Automated Flow Script

You can also use the automated script:

```bash
./scripts/test_tss_flow.sh
```

This script will guide you through the complete flow, prompting you to start nodes in separate terminals and automatically running operations and setting statuses.

## Commands

- `node` - Run a TSS node (requires `-validator-address` and `-private-key`)
- `keygen` - Generate a new keyshare (keyID is auto-generated by DKLS, no parameters needed)
- `keyrefresh` - Refresh the current keyshare (uses latest keyshare automatically)
- `qc` or `quorumchange` - Trigger a quorum change operation (add/remove participants, no parameters needed)
- `sign` - Sign a message (requires `-message` flag)
- `prepare` - Prepare environment (clean TSS files and build latest binary)
- `status` - Set node status (active, pending_join, pending_leave, inactive)

## Flags

### node command:

- `-validator-address` (required): Validator address (unique per node)
- `-private-key` (required): Ed25519 private key in hex format
- `-p2p-listen`: libp2p listen multiaddr (default: `/ip4/127.0.0.1/tcp/0`)
- `-home`: Directory for keyshare storage (default: `./tss-data/tss-<validator>`)
- `-db`: Database file path (default: `./tss-data/tss-<validator>.db`)
- `-password`: Encryption password for keyshares (default: `demo-password`)

### keygen command:

- No flags required (keyID is auto-generated by DKLS)

### keyrefresh command:

- No flags required (uses latest keyshare automatically)

### qc command:

- No flags required (uses latest keyshare and current validator set automatically)

### sign command:

- `-message` (required): Message string to sign

### prepare command:

- No flags required
- Performs two operations:
  1. **Cleans** all TSS-related files from `./tss-data`:
     - All `tss-*` directories (node home directories with keyshares)
     - All `tss-*.db` database files
     - The `tss-nodes.json` registry file
  2. **Builds** the latest binary to `./build/tss`

### status command:

- `-validator-address` (required): Validator address of the node
- `-status` (required): Status to set - one of: `active`, `pending_join`, `pending_leave`, `inactive`
- Example: `./build/tss status -validator-address=pushvaloper1... -status=active`
