name: Unit tests
on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: 1.22.3

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out source
        uses: actions/checkout@v4
        with:
          # persist-credentials allows git to access private repos in same org automatically
          persist-credentials: true

      - name: Configure Git for private repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git to use HTTPS
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          # Configure credential helper to use GITHUB_TOKEN
          git config --global credential.helper store
          # Store credentials for git operations
          echo "https://${GITHUB_TOKEN}@github.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Install Rust (for dkls23-rs dependency)
        uses: dtolnay/rust-toolchain@stable

      - name: Build dkls23-rs dependency
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: make build-dkls23

      - name: Verify go.mod was updated
        run: |
          echo "Current go.mod replace directive:"
          grep "go-wrapper =>" go.mod || echo "Not found"
          if grep -q "go-wrapper => \.\.\/dkls23-rs" go.mod; then
            echo "Warning: go.mod still uses local path, should be updated in CI"
          fi

      - name: Tests
        run: make test
